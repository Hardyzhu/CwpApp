<!--
	作者：yeshengqiang	
	时间：2016-06-27
	描述：安防预警列表
-->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>安防告警</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../js/mask/mask.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/add.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/new.css"/>
		<link rel="stylesheet" type="text/css" href="../../fonts/iconfont.css"/>
		<style>
			.mui-bar~.mui-content .mui-fullscreen {
				top: 50px;
				height: auto;
			}
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			.mui-pull-top-tips .mui-pull-loading {
				/*-webkit-backface-visibility: hidden;
				-webkit-transition-duration: 400ms;
				transition-duration: 400ms;*/
				
				margin: 0;
			}
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}
			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">安防告警</h1>
		</header>
		<!--内容部分-->
		<div class="mui-content">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item mui-active" href="#untreated">
						未处理
					</a>
					<a class="mui-control-item" href="#processing">
						处理中
					</a>
					<a class="mui-control-item" href="#processed">
						已处理
					</a>
				</div>
				<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-4"></div>
				<div class="mui-slider-group">
					<div id="untreated" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="mui-col-xs-12 mui-text-center">
									<!--<div class='mui-loading'>
										<div class='mui-spinner'></div>
									</div>-->	
								</div>
							</div>
						</div>
					</div>
					<div id="processing" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="mui-col-xs-12 mui-text-center">
									<!--<div class='mui-loading'>
										<div class='mui-spinner'></div>
									</div>-->
								</div>
							</div>
						</div>
					</div>
					<div id="processed" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<div class="mui-col-xs-12 mui-text-center">
									<!--<div class='mui-loading'>
										<div class='mui-spinner'></div>
									</div>-->
								</div>
							</div>
						</div>
					</div>
				</div>
				<!--<div class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item mui-active" href="#untreated">未处理</a>
					<a class="mui-control-item" href="#processing">处理中</a>
					<a class="mui-control-item" href="#processed">已处理</a>
				</div>-->
				<!--<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-4"></div>
				<div class="mui-slider-group">
					<div id="untreated" data-state="1" class="mui-slider-item mui-control-content mui-active">
						<div class="mui-content mui-scroll-wrapper" id="pullrefresh">
							<div class="mui-scroll">
								<div class="mui-col-xs-12" id="untreatedList">
										
								</div>
							</div>
						</div>
					</div>
					<div id="processing" data-state="2" class="mui-slider-item mui-control-content">
						<div class="mui-content mui-scroll-wrapper" id="pullrefresh">
							<div class="mui-scroll">
								<div class="mui-col-xs-12 mui-text-center" id="processingList">
									<div class='mui-loading'>
										<div class='mui-spinner'></div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="processed" data-state="3" class="mui-slider-item mui-control-content">
						<div class="mui-content mui-scroll-wrapper" id="pullrefresh">
							<div class="mui-scroll">
								<div class="mui-col-xs-12 mui-text-center" id="processedList">
									<div class='mui-loading'>
										<div class='mui-spinner'></div>
									</div>
								</div>
							</div>
						</div>
					</div>					
				</div>-->
			</div>
		</div>
		<script id="detailTmpl" type="text/html">
			{{each beans}}
				<div class="mui-col-xs-12 mb5 list-pannel clearfix listData">	
					{{if $value.warningLevel == 0}}
						<div class="icon iconfont icon-menjinxitong blueColor"></div>
					{{else if $value.warningLevel == 1}}
					    <div class="icon iconfont icon-menjinxitong yellowColor"></div>
					{{else if $value.warningLevel == 2}}
					    <div class="icon iconfont icon-menjinxitong orangeColor"></div>
					{{else}}
					   	<div class="icon iconfont icon-menjinxitong redColor"></div>
					{{/if}}
					<h3 class="list-title clearfix" style="padding: 0;">							
						{{if $value.alarmNumber != ""}}
								{{$value.alarmNumber}}
						{{else}}
						    	HWZJ201607201154123
						{{/if}}			
						<a data-id="{{$value.warningEventId}}" data-uid="{{$value.warningCategoryId}}" class="mui-pull-right goToDel list-link-a" href="javascript:void(0);">
							查看详情
							<span class="mui-icon mui-icon-arrowright"></span>
						</a>
					</h3>
					<div class="mui-col-xs-12 muiDetail">
						{{$value.eventDescribe}}
					</div>
					<div class="mui-col-xs-12 muiDetail clearfix">															
						<div class="fl goToDel list-link-a" href="javascript:void(0);">		
								{{if $value.eventProcessStatus == 1}}
						    			告警通知
								{{else if $value.eventProcessStatus == 2}}
								    	处理中
								{{else}}
								    	已恢复
								{{/if}}					
						</div>
						<div class="Timecolor fr">{{$value.applyTime}}</div>
					</div>
				</div>
		    {{/each}}		
		</script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/template.js"></script>
		<script src="../../js/mask/mask.js"></script>
		<script src="../../js/mui.conf.js"></script>
		<script>
			mui.init();
			(function($) {
				//阻尼系数
				var deceleration = mui.os.ios?0.003:0.0009;
				$('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration:deceleration
				});
				$.plusReady(function() {
					
					var self = plus.webview.currentWebview();
					var isLogin = plus.storage.getItem("userInfo");
					var userId=JSON.parse(isLogin).userId;
					var userRole=JSON.parse(isLogin).role[0].roleId;
					console.log("用户ID:"+userId)
					console.log("角色ID:"+userRole);
					//循环初始化所有下拉刷新，上拉加载。
					$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
						$(pullRefreshEl).pullToRefresh({
							up: {
								auto:true,
								callback: function() {
									var _self = this;
									setTimeout(function() {
										var dataList = _self.element.querySelector('.mui-text-center');
										getProductList(dataList, index, 5 ,userId);
										_self.endPullUpToRefresh();
									}, 1000);
								}
							}
						});
					});
					/*mui('.mui-control-content').each(function(){
						this.setAttribute("style","min-height:"+resHeight+"px;");
						var isActive = this.classList.contains('mui-active') ? true : false;
						if(isActive){
							var state = this.getAttribute('data-state');
							getProductList(state,'');
						}
					});*/
					var processing = document.getElementById("processing");;
					var processed = document.getElementById("processed");
					/*document.getElementById('slider').addEventListener('slide', function(e) {			
						if (e.detail.slideNumber === 1) {
							if (processing.querySelector('.mui-loading')) {
								if(JSON.parse(isLogin).role!=""||JSON.parse(isLogin).role!=0){
									for(var i = 0; i < JSON.parse(isLogin).role.length; i++){
										if(userRole=='8'||userRole=='12'){
											getProductList(2);
										}
										else if(userRole=='6'){
											getProductList(2,userId);
										}	
									}
								}
							
							}
						} else if (e.detail.slideNumber === 2) {
							if (processed.querySelector('.mui-loading')) {
								for(var i = 0; i < JSON.parse(isLogin).role.length; i++){
										if(userRole=='8'||userRole=='12'){
											getProductList(3,'');
										}
										else if(userRole=='6'){
											getProductList(3,userId);
										}	
								}
							}
						}
					});*/
					
					/**
					 * 跳转到详情页面
					 */
					mui('.mui-content').on('tap', '.goToDel', function(e) {
						qmask.show();
						var warningEventId = this.getAttribute("data-id");
						var warningCategoryId = this.getAttribute("data-uid");
						//判断是否有这个页面
						/*if(!detailPage){
						    detailPage = plus.webview.getWebviewById('securityAlarmDetail');
						}*/
						//自定义事件
				
						/*mui.fire(detailPage,'detailId',{
						    warningEventId:warningEventId,
						    warningCategoryId:warningCategoryId
						});*/
						/*setTimeout(function() {
							qmask.hide();
						}, 200);*/
						//打开页面
						mui.openWindow({
						  url:'../task/securityAlarmDetail.html',
						  id:'securityAlarmDetail',
						  waiting: {
							autoShow: false
						  },
						  extras: {
							warningEventId:warningEventId,
						    warningCategoryId:warningCategoryId
						  }
						});
					});
					
					//渲染数据
					function getProductList(obj,index,pageSize,userId) { //获取工单列表
						qmask.show();
						console.log("得到用户ID："+userId);
						var totalLength = obj.querySelectorAll('.listData').length;
						var page = (totalLength-pageSize)/pageSize;
						page += 2;
						console.log(page);
						obj.user_id = '';
						if(JSON.parse(isLogin).role!=""||JSON.parse(isLogin).role!=0){
							for(var i = 0; i < JSON.parse(isLogin).role.length; i++){
								if(userRole=='8'||userRole=='12'){
									obj.user_id = '';
								}
								else if(userRole=='6'){
									switch(++index){
										case 1:	
											obj.user_id = '';
											break;
										case 2:		
											obj.user_id = userId;
											break;
										case 3:
											obj.user_id = userId;
											break;
									}
								}	
							}
						}
						mui.ajax({
							url: global_url+"/cwp/front/sh/warningEvent!execute",
							type: "post",
							async: true,
							data: {
								uid: 'c016',
								currentPage:page,
								pageSize:pageSize,
								dictValue:'', 
								eventProcessStatus:index,
								eventType:2,
								responseOfficerId:obj.user_id
							},
							dataType: "json",
							timeout: 1000000,
							success: function(data) {
								console.log(JSON.stringify(data));
								var html = template('detailTmpl', data);
								obj.innerHTML += html;
								/*if(data.beans instanceof Array && data.beans.length<5){
									obj.mark = true;
									console.log(obj);
									//obj.disablePullupToRefresh();
									setTimeout(function(){
										//mui.toast('没有更多数据了!');
										var tipHtml="<div class=t-norecord><i class='icon iconfont icon-baogaoyichuangjian'></i><p>暂无数据记录</p></div>";
										switch(eventProcessStatus){
											case 1:			
												document.getElementById("untreatedList").innerHTML=tipHtml;
												break;
											case 2:	
												document.getElementById("processingList").innerHTML=tipHtml;
												break;
											case 3:
												document.getElementById("processedList").innerHTML=tipHtml;
												break;
										}
									},500);
									qmask.hide();
									return;
								}*/
								qmask.hide();
							},
							error: function(xhr, type, errorThrown) {
								if(type=='timeout'){
									mui.toast('请求超时:请检查网络!');
								}else {
									mui.toast('数据加载失败!');
								}
								qmask.hide();
							}
						});
					}
				});
			})(mui);
		</script>
		<!--<script src="../../js/home/securityAlarm1.js"></script>	-->	
	</body>
</html>
