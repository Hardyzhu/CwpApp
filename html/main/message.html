<!--
	作者：yeshengqiang	
	时间：2016-06-27
	描述：故障告警
-->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>消息</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../js/mask/mask.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css"/>
		<style>
			.mesR{
				position: relative;
			}
			.mesA{
				position: absolute;
				right:-5px;
				top:-5px;
				
			}
			.mesDate,
			.mesLevel{
				display:none;
				opacity: 0;
				filter:alpha(opacity:0);
			}
		</style>
	</head>
	<body>
		<!--内容部分-->
		<div class="mui-content mui-scroll-wrapper" id="pullrefresh">
			<div class="mui-scroll">
				<div class="mui-col-xs-12" id="list">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell mui-media">
							<a href="javascript:;">
								<span class="mui-media-object mui-pull-left mesR">
									<span class="mui-badge mui-badge-danger mesA"></span>
									<img class="mui-media-object" src="../../image/mes-01.png" />
								</span>
								<div class="mui-media-body">
									安防告警消息
									<span class="mui-pull-right com_detail_color mesDate"></span>
									<p class='mui-ellipsis'>
										<span class="mesCon"></span>
										<span class="mui-pull-right mesLevel"></span>
									</p>
								</div>
							</a>
						</li>	
					</ul>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell mui-media">
							<a href="javascript:;">
								<span class="mui-media-object mui-pull-left mesR">
									<span class="mui-badge mui-badge-danger mesA"></span>
									<img class="mui-media-object" src="../../image/mes-02.png" />
								</span>
								<div class="mui-media-body">
									故障告警消息
									<span class="mui-pull-right com_detail_color mesDate"></span>
									<p class='mui-ellipsis'>
										<span class="mesCon"></span>
										<span class="mui-pull-right mesLevel"></span>
									</p>
								</div>
							</a>
						</li>	
					</ul>
					<ul class="mui-table-view">
						<li class="mui-table-view-cell mui-media">
							<a href="javascript:;">
								<span class="mui-media-object mui-pull-left mesR">
									<span class="mui-badge mui-badge-danger mesA"></span>
									<img class="mui-media-object" src="../../image/mes-03.png" />
								</span>
								<div class="mui-media-body">
									工单待办消息
									<span class="mui-pull-right com_detail_color mesDate"></span>
									<p class='mui-ellipsis'>
										<span class="mesCon"></span>
										<span class="mui-pull-right mesLevel"></span>
									</p>
								</div>
							</a>
						</li>	
					</ul>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/template.js"></script>
		<script src="../../js/mask/mask.js"></script>
		<script src="../../js/mui.conf.js"></script>
		<script src="../../js/DBUtils.js"></script>	
		<script src="../../js/getData.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			var userId;
			var message = null;
			// 监听plusready事件  
			
			document.addEventListener( "plusready", function(){
				var pram = {
					status:'0',
					type:'SECURITY'
				};
				$$.selectData(pram);
				$$.selectData({type:'WARN'});
				$$.selectData({type:'ORDER'});
				message = document.getElementById("message");
				plus.push.addEventListener( "click", function( msg ) {
                    // 判断是从本地创建还是离线推送的消息
                    switch (msg.payload) {
                        case "LocalMSG":
                            outSet("点击本地创建消息启动：");
                            break;
                        default:
                        	saveMsg(msg);
                            outSet("点击离线推送消息启动：");
                            break;
                    }
                    // 处理其它数据
					logoutPushMsg( msg );
			    }, false );
			    // 监听在线消息事件
			    plus.push.addEventListener( "receive", function( msg ) {
                    if (msg.aps) { // Apple APNS message
                        alert("接收到在线APNS消息：");
                    } else {
                        alert("接收到在线透传消息：");
                    }
                    saveMsg(msg);
			    }, false );
			    
			    
				function saveMsg(msg){
					var data = eval('('+msg.payload+')');
					alert(JSON.stringify(data));
					alert(data.content);
					alert(data.eventId);
					var msgJs={
            			eventId:data.eventId,
			    		title:msg.title,
			    		type:data.messageType,
			    		content:msg.content,
			    		processAction:data.processAction,
			    		messageNo:data.messageNo,
			    		messageLevel:data.messageLevel,
			    		status:'0'
	            	};
			    	alert(JSON.stringify(msgJs));
			    	websql.insertPushMessage(msgJs,function(res){
			    		/*alert('远程消息返回值'+res.responseData);
			    		alert('远程消息返回状态'+res.status);*/
			    		//预加载
						//新消息获取个数
						
//						websql.selectPushMsgByType({type:'SECURITY'},function(res){
//							if((res.responseData instanceof Array)&&(res.responseData.length>0)){
//								//result = res.responseData[0];
//								alert(JSON.stringify(res.responseData[0]));
//								alert(JSON.stringify(res.responseData));
//								//mark = true;
//							}
//						 	/*if(res.responseData.length>0){
//						 		document.getElementById("eventOrder").innerHTML=res.responseData[0].content;
//						 		document.getElementById("ordertime").innerHTML=res.responseData[0].pushDate;
//						 		document.getElementById("ordername").innerHTML=res.responseData[0].pushDate;
//						 	}else{
//						 		document.getElementById("eventOrder").innerHTML='暂无消息';
//						 		document.getElementById("ordertime").innerHTML='';
//						 		document.getElementById("ordername").innerHTML='陈金波';
//						 	}*/
//						});
//						websql.selectPushMsgByType({type:'WARN'},function(res){
//							if((res.responseData instanceof Array)&&(res.responseData.length>0)){
//								//result = res.responseData[0];
//								alert(JSON.stringify(res.responseData[0]));
//								alert(JSON.stringify(res.responseData));
//								//mark = true;
//							}
//						 	/*if(res.responseData.length>0){
//						 		document.getElementById("eventOrder").innerHTML=res.responseData[0].content;
//						 		document.getElementById("ordertime").innerHTML=res.responseData[0].pushDate;
//						 		document.getElementById("ordername").innerHTML=res.responseData[0].pushDate;
//						 	}else{
//						 		document.getElementById("eventOrder").innerHTML='暂无消息';
//						 		document.getElementById("ordertime").innerHTML='';
//						 		document.getElementById("ordername").innerHTML='陈金波';
//						 	}*/
//						});
//						websql.selectPushMsgByType({type:'ORDER'},function(res){
//							if((res.responseData instanceof Array)&&(res.responseData.length>0)){
//								//result = res.responseData[0];
//								alert(JSON.stringify(res.responseData[0]));
//								alert(JSON.stringify(res.responseData));
//								//mark = true;
//							}
//						 	/*if(res.responseData.length>0){
//						 		document.getElementById("eventOrder").innerHTML=res.responseData[0].content;
//						 		document.getElementById("ordertime").innerHTML=res.responseData[0].pushDate;
//						 		document.getElementById("ordername").innerHTML=res.responseData[0].pushDate;
//						 	}else{
//						 		document.getElementById("eventOrder").innerHTML='暂无消息';
//						 		document.getElementById("ordertime").innerHTML='';
//						 		document.getElementById("ordername").innerHTML='陈金波';
//						 	}*/
//						});
						/*var mes = {};
						$$.selectData({status:'0'});
						mes.security = $$.selectData({type:'SECURITY'});
						mes.warn = $$.selectData({type:'WARN'});
						mes.order = $$.selectData({type:'ORDER'});
						alert(JSON.stringify(mes));
						for(var i = 0 in count_obj){
							switch(i){
								case 'security':
									mes.security.count(count_obj[i]);
									break;
								case 'warn':
									mes.warn.count(count_obj[i]);
									break;
								case 'order':
									mes.order.count(count_obj[i]);
									break;
							}
						}
						alert(JSON.stringify(mes));
						//渲染数据
						
						var oList = document.getElementById("list");
						var html = template('detailTmpl', mes);
						oList.innerHTML += html;*/
						var pram = {
							status:'0',
							type:'SECURITY'
						};
						$$.selectData(pram);
						$$.selectData({type:'WARN'});
						$$.selectData({type:'ORDER'});
						/*mes.security = $$.selectData({});
						mes.warn = $$.selectData({});
						mes.order = $$.selectData({});*/
						template.helper('numFormat',function(inp){
							if(inp>=99){
								return '99+';
							}else{
								return inp;
							}
						});
			    	});
				}
				
				
			}, false );
			
			/*mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				/*var message = null;
				message = document.getElementById('message');*/
				
			    
			//});*/
		</script>
	</body>
</html>

