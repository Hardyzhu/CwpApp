<!--
	作者：yeshengqiang	
	时间：2016-06-27
	描述：故障告警
-->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>消息</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="HandheldFriendly" content="true"/>
		<meta name="MobileOptimized" content="320"/>
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../js/mask/mask.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css"/>
		<style>
			.mesR{
				position: relative;
			}
			.mesA{
				position: absolute;
				right:-5px;
				top:-5px;
				display:none;
				opacity: 0;
				filter:alpha(opacity:0);
			}
			.mesDate,
			.mesLevel{
				/*display:none;
				opacity: 0;
				filter:alpha(opacity:0);*/
			}
			#list{
				margin:5px 0;
			}
		</style>
	</head>
	<body>
		<!--内容部分-->
		<div class="mui-content mui-scroll-wrapper" id="pullrefresh">
			<div class="mui-scroll">
				<div class="mui-col-xs-12" id="list">
					<ul data-state="1" id="securityTip" class="mui-table-view mb5">
						<li class="mui-table-view-cell mui-media">
							<a href="javascript:;">
								<span class="mui-media-object mui-pull-left mesR">
									<span class="mui-badge mui-badge-danger mesA"></span>
									<img class="mui-media-object" src="../../image/mes-01.png" />
								</span>
								<div class="mui-media-body" id="securityTmp">
									<!--安防告警消息-->
								</div>
							</a>
						</li>	
					</ul>
					<ul data-state="2" id="faultTip" class="mui-table-view mb5">
						<li class="mui-table-view-cell mui-media">
							<a href="javascript:;">
								<span class="mui-media-object mui-pull-left mesR">
									<span class="mui-badge mui-badge-danger mesA"></span>
									<img class="mui-media-object" src="../../image/mes-02.png" />
								</span>
								<div class="mui-media-body" id="warnTmp">
									<!--故障告警消息-->
								</div>
							</a>
						</li>
					</ul>
					<ul data-state="3" id="orderTip" class="mui-table-view">
						<li class="mui-table-view-cell mui-media">
							<a href="javascript:;">
								<span class="mui-media-object mui-pull-left mesR">
									<span class="mui-badge mui-badge-danger mesA"></span>
									<img class="mui-media-object" src="../../image/mes-03.png" />
								</span>
								<div class="mui-media-body" id="orderTmp">
									<!--工单待办消息-->
								</div>
							</a>
						</li>	
					</ul>
				</div>
			</div>
		</div>
		<script type="text/html" id="securityTmpl">
			<div class="title clearfix">
				安防告警消息
				<span class="mui-pull-right com_detail_color mesDate">{{createTime}}</span>
			</div>			
			<p class='mui-ellipsis clearfix'>
				<span class="mesCon mui-pull-left">{{content | isnotNull}}</span>
				<span class="mui-pull-right mesLevel">{{processAction}}</span>	
			</p>
			
		</script>
		<script type="text/html" id="warnTmpl">
			<div class="title clearfix">
				故障告警消息
				<span class="mui-pull-right com_detail_color mesDate">{{createTime}}</span>
			</div>
			<p class='mui-ellipsis clearfix'>
				<span class="mui-pull-left mesCon">{{content | isnotNull}}</span>
				<span class="mui-pull-right mesLevel">{{processAction}}</span>
			</p>
		</script>
		<script type="text/html" id="orderTmpl">
			<div class="title clearfix">
				工单待办消息
				<span class="mui-pull-right com_detail_color mesDate">{{createTime}}</span>
			</div>
			<p class='mui-ellipsis clearfix'>
				<span class="mui-pull-left mesCon">{{content | isnotNull}}</span>
				<span class="mui-pull-right mesLevel">{{processAction}}</span>
			</p>
		</script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/template.js"></script>
		<script src="../../js/mask/mask.js"></script>
		<script src="../../js/mui.conf.js"></script>
		<script src="../../js/DBUtils.js"></script>	
		<script src="../../js/getData.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			//var message = null;
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				var isLogin = plus.storage.getItem("userInfo");
				var userRole=JSON.parse(isLogin).role[0].roleId;
				if(JSON.parse(isLogin).role!=""||JSON.parse(isLogin).role!=0){
					var securityTip=document.getElementById("securityTip");
					var faultTip=document.getElementById("faultTip");
					var orderTip=document.getElementById("orderTip");
					for(var i = 0; i < JSON.parse(isLogin).role.length; i++){
						console.log(userRole);
						if(userRole=='14'||userRole=='4'||userRole=='13'){
							securityTip.style.display="none";
							faultTip.style.display="block";
							orderTip.style.display="block";
						}else if(userRole=='5'||userRole=='6'||userRole=='12'||userRole=='15'){
							securityTip.style.display="block";
							faultTip.style.display="none";
							orderTip.style.display="none";
						}else if(userRole=='4'){
							securityTip.style.display="none";
							faultTip.style.display="block";
							orderTip.style.display="none";
						}
						else if(userRole=='2'||userRole=='3'||userRole=='8'){
							securityTip.style.display="block";
							faultTip.style.display="block";
							orderTip.style.display="block";
						}
					}
				}
				
				
			});
			
			// 监听plusready事件  
			document.addEventListener( "plusready", function(){
				$$.selectData('1',{status:'0'});
				$$.selectData('1',{type:'SECURITY'});
				$$.selectData('1',{type:'WARN'});
				$$.selectData('1',{type:'ORDER'});
				//message = document.getElementById("message");
				
				window.addEventListener('opens',function(e){
					$$.selectData('1',{status:'0'});
					$$.selectData('1',{type:'SECURITY'});
					$$.selectData('1',{type:'WARN'});
					$$.selectData('1',{type:'ORDER'});
				});
				
				plus.push.addEventListener( "click", function( msg ) {
                    // 判断是从本地创建还是离线推送的消息
                    var mainer = null,mainID=null;
			        var selfer = plus.webview.currentWebview();
			        var mainID = plus.webview.getWebviewById('main.html');
			        var mainer = mainID || plus.webview.create('main.html'); //创建主页
                    switch (msg.payload) {
                        case "LocalMSG":
                            //outSet("点击本地创建消息启动：");
                            break;
                        default:
                        	saveMsg(msg);
                        	mainer.evalJS('goMessage()');
                        	selfer.hide('none');
					        setTimeout(function(){
					           mainer.show('none');
					        },50);
                            //outSet("点击离线推送消息启动：");
                            break;
                    }
                    // 处理其它数据
//					logoutPushMsg(msg);
			    }, false );
			    // 监听在线消息事件
			    plus.push.addEventListener( "receive", function( msg ) {
                    if (msg.aps) { // Apple APNS message
                        //alert("接收到在线APNS消息：");
                    } else {
                        //alert("接收到在线透传消息：");
                    }
                    saveMsg(msg);
			    }, false );
			    
			    //点击跳入对应的详情页面
			    var oList = document.getElementById('list'),
			    	aUl = oList.querySelectorAll('ul');
			    for(var i=0;i<aUl.length;i++){
			    	aUl[i].addEventListener('tap',function(){
			    		var state = this.getAttribute('data-state');
			    		// 有没有最新消息都可以进入查询
/*			    		var con = this.querySelector('.mesA').innerHTML;
			    		if(con==''||con==null){
			    			mui.toast('暂无最新消息!');
			    			return;
			    		}*/
			    		mui.openWindow({
							url: 'messageDetail.html',
							id: 'messageDetail',
							waiting: {
								autoShow: false
							},
							extras: {
								bstate: state
							}
						});
			    	});
			    }
			    //存储消息
				function saveMsg(msg){					
					var data = eval('('+msg.payload+')');
					var nowTime=getNowFormatDate();
					var msgJs={
            			eventId:data.eventId,
			    		title:msg.title,
			    		type:data.messageType,
			    		content:msg.content,
			    		processAction:data.processAction,
			    		messageNo:data.messageNo,
			    		messageLevel:data.messageLevel,
			    		warningType:data.warningType,
			    		createTime:nowTime,
			    		status:'0'
	            	};
					//向websql里面新增数据
					//alert(JSON.stringify(msgJs));
			    	websql.insertPushMessage(msgJs,function(res){
						$$.selectData('1',{status:'0'});
						$$.selectData('1',{type:'SECURITY'});
						$$.selectData('1',{type:'WARN'});
						$$.selectData('1',{type:'ORDER'});
			    	});
				}
			}, false );
			
			//获取当前的日期时间 格式“yyyy/MM/dd HH:MM:SS”
			function getNowFormatDate() {
				var date = new Date();
				var seperator1 = "/";
				var seperator2 = ":";
				var month = date.getMonth() + 1;
				var strDate = date.getDate();
				if (month >= 1 && month <= 9) {
					month = "0" + month;
				}
				if (strDate >= 0 && strDate <= 9) {
					strDate = "0" + strDate;
				}
				var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
						+ " " + date.getHours() + seperator2 + date.getMinutes()
						+ seperator2 + date.getSeconds();
				return currentdate;
			}
		</script>
	</body>
</html>

